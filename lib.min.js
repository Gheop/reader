var kona=0,search_value='',search_active=0,search_focus=0,requestTimer=false,loadmore,nb_title=0,id='all',unr=0,d,m,varscroll=0,loadinprogress=0,zhr,totalItems=0,readItems=0;online=true;notif=false;var Now;var favicon_badge;var rtf;var syncInterval=null;var cacheVersion='v1';var locallyModifiedArticles={};var eventSource=null;const hasSupportLoading='loading' in HTMLImageElement.prototype;if(!/iPad|iPhone|iPod/.test(navigator.platform)){const locale=navigator.language;rtf=new Intl.RelativeTimeFormat(locale,{numeric:'auto'});}const D=document;const DM=document.getElementsByTagName("main")[0];var cptReadArticle=0;var imageObserver;function $(i){return D.getElementById(i);}function saveToCache(data){try{localStorage.setItem('reader_cache_'+cacheVersion,JSON.stringify(data));localStorage.setItem('reader_cache_timestamp',Date.now());}catch(e){console.error('Failed to save to localStorage:',e);}}function loadFromCache(){try{const cached=localStorage.getItem('reader_cache_'+cacheVersion);if(cached){return JSON.parse(cached);}}catch(e){console.error('Failed to load from localStorage:',e);}return null;}function getCacheAge(){const timestamp=localStorage.getItem('reader_cache_timestamp');if(!timestamp)return Infinity;return Date.now()-parseInt(timestamp);}function clearCache(){try{localStorage.removeItem('reader_cache_'+cacheVersion);localStorage.removeItem('reader_cache_timestamp');}catch(e){console.error('Failed to clear cache:',e);}}function loadData(feedId,useCache=true){if(useCache){const cached=loadFromCache();if(cached&&cached.menu&&cached.articles){console.log('Loading from cache(age:'+Math.round(getCacheAge()/1000)+'s)');renderMenu(cached.menu);var displayFeed=(feedId==='all'&&id!=='all')? id:(feedId||'all');renderArticles(cached.articles,displayFeed);setTimeout(()=>fetchAndUpdateData(feedId),100);return;}}console.log('No cache available,loading from server');fetchAndUpdateData(feedId);}function fetchAndUpdateData(feedId){const url=feedId&&feedId!=='all' ? 'api.php?id='+feedId:'api.php';console.log('Fetching data from:',url);fetch(url).then(response=>{console.log('Response status:',response.status);if(!response.ok){throw new Error('HTTP error '+response.status);}return response.json();}).then(data=>{console.log('Data received:',data);if(data.menu&&data.articles){console.log('Menu items:',Object.keys(data.menu).length);console.log('Articles:',Object.keys(data.articles).length);if(!feedId||feedId==='all'){saveToCache(data);}else{console.log('Skipping cache save for filtered feed',feedId);}renderMenu(data.menu);var displayFeed=(feedId==='all'&&id!=='all')? id:(feedId||'all');renderArticles(data.articles,displayFeed,true);}else{console.error('Invalid data structure:',data);}}).catch(err=>{console.error('Failed to fetch data:',err);if(typeof affError!=='undefined'){affError('Erreur de chargement des données');}});}let preloadedFeeds={};let isPreloading=false;function preloadFeedArticles(feedId){if(preloadedFeeds[feedId]||isPreloading){console.log('Preload skipped for feed',feedId,'-already preloaded:',!!preloadedFeeds[feedId],'isPreloading:',isPreloading);return;}if(!m||!m[feedId]||m[feedId].n===0){console.log('Preload skipped for feed',feedId,'-no unread articles');return;}console.log('===PRELOADING feed',feedId,'with',m[feedId].n,'articles===');isPreloading=true;const url='api.php?id='+feedId+'&nb=200';fetch(url,{credentials:'same-origin'}).then(response=>{if(!response.ok){throw new Error('HTTP error '+response.status);}return response.json();}).then(data=>{if(data.articles){console.log('PRELOAD:Received',Object.keys(data.articles).length,'articles for feed',feedId);if(!d)d={};let newCount=0;for(let articleId in data.articles){if(!d[articleId]){d[articleId]=data.articles[articleId];d[articleId].r=1;d[articleId].readblock=0;newCount++;}}console.log('PRELOAD:Added',newCount,'new articles to memory for feed',feedId);preloadedFeeds[feedId]=true;if(m){saveToCache({menu:m,articles:d,timestamp:Date.now()});}}}).catch(err=>{console.error('Preload failed for feed',feedId,':',err);}).finally(()=>{isPreloading=false;});}function renderMenu(menuData){var oldCounters={};var oldFeedsVisible={};var locallyModified={};if(m){for(var i in m){oldCounters[i]=m[i].n||0;oldFeedsVisible[i]=m[i].n>0;if(readBatchQueue.length>0&&oldCounters[i]!==undefined){locallyModified[i]=true;}}}nb_title=0;var currentFeedData=null;if(id!=='all'&&m&&m[id]&&!menuData[id]){currentFeedData=m[id];console.log('Preserving currently selected feed',id,'in menu');}for(var i in menuData){if(m&&m[i]&&m[i].locallyModified&&m[i].n<menuData[i].n){console.log('Keeping local counter for feed',i,'-Local:',m[i].n,'Server:',menuData[i].n);menuData[i].n=m[i].n;menuData[i].locallyModified=true;}}m=menuData;if(currentFeedData){m[id]=currentFeedData;m[id].n=0;}var menu='\t<li id="fsearch" class="flux" title="Recherche" onclick="return false;">Résultats de la recherche</li>\n';var changedFeeds=[];var newFeeds=[];var feedsToShow={};for(var i in m){var isCurrentFeed=(id==i);var shouldShow=(m[i].n>0)||isCurrentFeed;if(shouldShow){feedsToShow[i]=true;var feedClass=(m[i].n>0)? 'fluxnew':'flux';var counterDisplay=(m[i].n>0)? '<span class="nb_flux">'+m[i].n+'</span>':'';menu+='\t<li id="f'+i+'" class="'+feedClass+'" title="'+m[i].d+'" onclick="view('+i+');">'+m[i].t+counterDisplay+'<span class="icon"><a title="Tout marquer comme lu" onclick="markallread('+i+')"></a><a title="Se désabonner" onclick="unsubscribe(\''+m[i].t.replace(/'/g,"\\\'")+'\','+i+')"></a></span></li>\n';nb_title+=m[i].n||0;if(oldCounters[i]!==undefined&&oldCounters[i]!==m[i].n){changedFeeds.push(i);}var isPreservedCurrentFeed=(currentFeedData&&i==id);if((oldFeedsVisible[i]===false||oldFeedsVisible[i]===undefined)&&!isPreservedCurrentFeed){newFeeds.push(i);}}}var structuralChanges=newFeeds.length>0;if(!structuralChanges&&oldFeedsVisible){for(var i in oldFeedsVisible){if(oldFeedsVisible[i]&&!feedsToShow[i]){structuralChanges=true;break;}}}const menuEl=$('menu');if(structuralChanges||menuEl.children.length<=1){while(menuEl.children.length>1){menuEl.removeChild(menuEl.lastChild);}menuEl.insertAdjacentHTML('beforeend',menu);}else{for(var i in changedFeeds){var feedId=changedFeeds[i];var feedEl=$('f'+feedId);if(feedEl){var counterSpan=feedEl.querySelector('.nb_flux');if(m[feedId].n>0){if(counterSpan){counterSpan.textContent=' '+m[feedId].n;}else{var titleText=feedEl.firstChild;feedEl.insertAdjacentHTML('afterbegin',feedEl.textContent.split('<span')[0]+'<span class="nb_flux">'+m[feedId].n+'</span>');}feedEl.className='fluxnew';}else{if(counterSpan){counterSpan.remove();}feedEl.className='flux';}}}}newFeeds.forEach(function(feedId){if($('f'+feedId)){$('f'+feedId).classList.add('fade-in-new');setTimeout(()=>{if($('f'+feedId))$('f'+feedId).classList.remove('fade-in-new');},600);}});changedFeeds.forEach(function(feedId){if($('f'+feedId)&&!newFeeds.includes(feedId)){setTimeout(()=>light('f'+feedId),100);}});if(id==='all'&&$('fall')){$('fall').classList.add('show');}else if(id!=='all'&&$('f'+id)){$('f'+id).classList.add('show');}D.title='Gheop Reader'+((nb_title>0)? '('+nb_title+')':'');favicon(nb_title);totalItems=nb_title;readItems=0;progressBar();}function renderArticles(articlesData,feedId,fromAPI=false){console.log('renderArticles called with feedId:',feedId,'fromAPI:',fromAPI);console.log('articlesData keys:',Object.keys(articlesData).length);let page='';cptReadArticle=0;varscroll=0;loadmore=0;d=articlesData;for(let i in d){if(fromAPI){d[i].r=1;d[i].readblock=0;}else if(d[i].r===undefined){d[i].r=1;d[i].readblock=0;}}Now=new Date();for(let i in d){if(feedId&&feedId!=='all'&&d[i].f!=feedId){console.log('Skipping article',i,'feed:',d[i].f,'looking for:',feedId);continue;}if(d[i].r===0){console.log('Skipping read article',i);continue;}loadmore++;page+=generateArticle(i);}console.log('Generated',loadmore,'articles');if(loadmore==0){page='<article class="item1">\n\t<header>\n\t\t<h1 class="headline"><a class="title" target="_blank">Flux vide</a></h1>\n\t\t<div class="byline vcard">\n\t\t\t<address class="author"><a class="website">Gheop Reader</a></address>\n\t\t\t<time>Maintenant</time>\n\t\t</div>\n\t</header>\n\t<div class="article-content">Pas de nouveaux articles.</div>\n\t<div class="action">&nbsp;&nbsp;</div>\n</article>';}page+='<div id="addblank">&nbsp;</div>';DM.innerHTML=page;DM.scrollTop=0;DM.addEventListener('DOMMouseScroll',scroll,false);DM.onscroll=scroll;DM.onmousewheel=scroll;DM.scrollTop=0;if(loadmore>0){if(loadmore)$('addblank').style.height=(DM.offsetHeight-60)+'px';scroll();}}function startSSEConnection(){if(eventSource){eventSource.close();eventSource=null;}if(typeof EventSource==='undefined'){console.warn('SSE not supported,falling back to polling');startBackgroundSync(30);return;}console.log('Establishing SSE connection...');eventSource=new EventSource('sse.php');eventSource.addEventListener('connected',function(e){const data=JSON.parse(e.data);console.log('SSE connected:',data);});eventSource.addEventListener('update',function(e){const data=JSON.parse(e.data);console.log('SSE update received:',data);fetchAndUpdateDataBackground();});eventSource.addEventListener('heartbeat',function(e){const data=JSON.parse(e.data);console.log('SSE heartbeat:',data.timestamp);});eventSource.addEventListener('timeout',function(e){console.log('SSE timeout,reconnecting...');setTimeout(()=>startSSEConnection(),1000);});eventSource.onerror=function(e){console.error('SSE error:',e);eventSource.close();eventSource=null;setTimeout(()=>startSSEConnection(),5000);};}function stopSSEConnection(){if(eventSource){console.log('Closing SSE connection');eventSource.close();eventSource=null;}}function startBackgroundSync(intervalSeconds=30){if(syncInterval){clearInterval(syncInterval);}syncInterval=setInterval(()=>{console.log('Background sync(polling)...');fetchAndUpdateDataBackground();},intervalSeconds*1000);}async function fetchAndUpdateDataBackground(){console.log('===SSE BACKGROUND SYNC START===');const timeSinceLastRead=Date.now()-lastReadActivity;if(timeSinceLastRead<2000){console.log('SSE:Recent read activity detected(',timeSinceLastRead,'ms ago),delaying sync for 2 seconds...');setTimeout(()=>fetchAndUpdateDataBackground(),2000);return;}console.log('SSE:No recent read activity,flushing pending read requests...');await flushReadBatch();console.log('SSE:Flush complete,now fetching data...');const url='api.php';console.log('Background fetching data from:',url);fetch(url,{credentials:'same-origin'}).then(response=>{if(!response.ok){throw new Error('HTTP error '+response.status);}return response.json();}).then(data=>{if(data.menu&&data.articles){console.log('Background sync:Menu items:',Object.keys(data.menu).length,'Articles:',Object.keys(data.articles).length);saveToCache(data);renderMenu(data.menu);appendNewArticles(data.articles);}}).catch(err=>{console.error('Background sync failed:',err);});}function appendNewArticles(newArticlesData){var newArticles=[];var removedArticles=[];var reactivatedArticles=[];for(var i in newArticlesData){if(id==='all'||newArticlesData[i].f==id){if($(i)&&$(i).className==='item0'){reactivatedArticles.push(i);}else if(!d||!d[i]){if(!$(i)){newArticles.push(i);}}}}if(d){for(var i in d){if(!newArticlesData[i]){if($(i)){removedArticles.push(i);}}}}console.log('SSE:Found',newArticles.length,'new articles,',reactivatedArticles.length,'reactivated articles,and',removedArticles.length,'removed articles for current view');var newDataCount=Object.keys(newArticlesData).length;var oldDataCount=d ? Object.keys(d).length:0;console.log('SSE:Old data had',oldDataCount,'articles,new data has',newDataCount,'articles');for(var i in newArticlesData){newArticlesData[i].r=1;newArticlesData[i].readblock=0;}for(var i in locallyModifiedArticles){if(d&&d[i]){newArticlesData[i]=d[i];console.log('SSE:Preserving locally modified article',i);}}if(d){var preservedCount=0;for(var i in d){if(!newArticlesData[i]&&$(i)&&!locallyModifiedArticles[i]){newArticlesData[i]=d[i];preservedCount++;}}console.log('SSE:Preserved',preservedCount,'read articles from DOM');}d=newArticlesData;console.log('SSE:Updated global data object to',Object.keys(d).length,'articles');if(removedArticles.length>0){removedArticles.forEach(function(articleId){if(locallyModifiedArticles[articleId]){console.log('Skipping article',articleId,'-locally modified');return;}var article=$(articleId);if(article){article.className='item0';if(d[articleId]){d[articleId].r=0;}}});console.log('Marked',removedArticles.length,'articles as read(from other device)');if(id!=='all'){var hasUnreadArticlesForCurrentFeed=false;for(var i in d){if(d[i].f==id){hasUnreadArticlesForCurrentFeed=true;break;}}console.log('Checking if feed',id,'has unread articles:',hasUnreadArticlesForCurrentFeed);if(!hasUnreadArticlesForCurrentFeed){console.log('Current feed has no more unread articles,switching to "All"');var oldFeed=$('f'+id);if(oldFeed){oldFeed.classList.remove('show');}id='all';if($('fall')){$('fall').classList.add('show');}renderArticles(d,'all');}}}if(reactivatedArticles.length>0){console.log('SSE:Processing',reactivatedArticles.length,'reactivated articles:',reactivatedArticles.join(','));var articles=DM.querySelectorAll('article');articles.forEach(function(article){var titleLink=article.querySelector('.title');if(titleLink&&titleLink.textContent==='Flux vide'){console.log('SSE:Removing "Flux vide" message(reactivated articles)');article.remove();}});reactivatedArticles.forEach(function(articleId){var article=$(articleId);if(article&&article.className==='item0'){article.className='item1';console.log('SSE:Reactivated article',articleId,'from read to unread(feed:',d[articleId].f,')');article.classList.add('fade-in-new');setTimeout(()=>{if($(articleId))$(articleId).classList.remove('fade-in-new');},600);}});console.log('SSE:Reactivated',reactivatedArticles.length,'articles');}if(newArticles.length>0){Now=new Date();var articles=DM.querySelectorAll('article');articles.forEach(function(article){var titleLink=article.querySelector('.title');if(titleLink&&titleLink.textContent==='Flux vide'){console.log('Removing "Flux vide" message');article.remove();}});var addBlank=$('addblank');if(addBlank){var newPage='';newArticles.forEach(function(articleId){loadmore++;newPage+=generateArticle(articleId);});addBlank.insertAdjacentHTML('beforebegin',newPage);newArticles.forEach(function(articleId){if($(articleId)){$(articleId).classList.add('fade-in-new');$(articleId).dataset.newArticle='true';setTimeout(()=>{if($(articleId))$(articleId).classList.remove('fade-in-new');},600);}});scroll();setTimeout(()=>{newArticles.forEach(function(articleId){if($(articleId)){delete $(articleId).dataset.newArticle;}});},2000);console.log('Appended',newArticles.length,'new articles to DOM');}}}function stopBackgroundSync(){if(syncInterval){clearInterval(syncInterval);syncInterval=null;}}let readBatchQueue=[];let readBatchTimeout=null;let lastReadActivity=0;function flushReadBatch(){if(readBatchQueue.length===0)return Promise.resolve();const idsToMark=[...readBatchQueue];readBatchQueue=[];console.log('FLUSHING BATCH:Marking',idsToMark.length,'articles as read on server');const data='ids='+idsToMark.join(',');return myFetch('read.php',data,1).then(()=>{console.log('BATCH SUCCESS:Marked',idsToMark.length,'articles as read');for(var feedId in m){if(m[feedId].locallyModified){m[feedId].locallyModified=false;}}}).catch(err=>{console.error('Batch read failed,retrying individually:',err);idsToMark.forEach(id=>myFetch('read.php','id='+id,1));});}function queueReadRequest(articleId){readBatchQueue.push(articleId);console.log('QUEUE:Article',articleId,'added to batch queue(',readBatchQueue.length,'in queue)');lastReadActivity=Date.now();clearTimeout(readBatchTimeout);if(readBatchQueue.length>=20){console.log('QUEUE:Auto-flushing(20 items reached)');flushReadBatch();}else{readBatchTimeout=setTimeout(flushReadBatch,500);}}let faviconTimeout;let lastFaviconUpdate=0;function favicon(nb){if(nb<0)return;const now=Date.now();clearTimeout(faviconTimeout);faviconTimeout=setTimeout(()=>{try{if(favicon_badge)favicon_badge.badge(nb);}catch(e){console.warn('Favicon update failed:',e.message);}lastFaviconUpdate=now;},100);}function changeTheme(style){if(imageObserver)imageObserver.disconnect();const currentTheme=localStorage.getItem('theme')||'auto';let nextTheme;if($('stylesheet').href.includes('light.css')){nextTheme='dark';}else if($('stylesheet').href.includes('dark.css')){nextTheme='adaptive';}else if($('stylesheet').href.includes('adaptive.css')){nextTheme='smooth';}else{nextTheme='light';}if(nextTheme==='light'){$('stylesheet').href='themes/light.css';localStorage.setItem('theme','light');}else if(nextTheme==='dark'){$('stylesheet').href='themes/dark.css';localStorage.setItem('theme','dark');}else if(nextTheme==='adaptive'){$('stylesheet').href='themes/adaptive.css';localStorage.setItem('theme','adaptive');setTimeout(()=>{if(window.startAdaptiveTheme){startAdaptiveTheme();}},100);}else if(nextTheme==='smooth'){$('stylesheet').href='themes/adaptive-smooth.css';localStorage.setItem('theme','smooth');setTimeout(()=>{if(window.startSmoothAdaptiveTheme){startSmoothAdaptiveTheme();}},100);}updateThemeIcon();setTimeout(scroll,2000);}function toggleThemeDropdown(){const dropdown=$('theme-dropdown');if(dropdown){dropdown.classList.toggle('theme-dropdown-hidden');}}function selectTheme(themeName){const dropdown=$('theme-dropdown');if(dropdown){dropdown.classList.add('theme-dropdown-hidden');}if(imageObserver)imageObserver.disconnect();if(themeName==='light'){$('stylesheet').href='themes/light.css';localStorage.setItem('theme','light');}else if(themeName==='dark'){$('stylesheet').href='themes/dark.css';localStorage.setItem('theme','dark');}else if(themeName==='adaptive'){$('stylesheet').href='themes/adaptive.css';localStorage.setItem('theme','adaptive');setTimeout(()=>{if(window.startAdaptiveTheme){startAdaptiveTheme();}},100);}else if(themeName==='smooth'){$('stylesheet').href='themes/adaptive-smooth.css';localStorage.setItem('theme','smooth');setTimeout(()=>{if(window.startSmoothAdaptiveTheme){startSmoothAdaptiveTheme();}},100);}else if(themeName==='modern'){$('stylesheet').href='themes/modern.css';localStorage.setItem('theme','modern');}updateThemeIcon();setTimeout(scroll,2000);}function updateThemeIcon(){const themeCurrent=$('theme-current');if(!themeCurrent)return;const stylesheet=$('stylesheet').href;let iconClass='';if(stylesheet.includes('light.css')){iconClass='theme-icon-light';}else if(stylesheet.includes('dark.css')){iconClass='theme-icon-dark';}else if(stylesheet.includes('adaptive.css')){iconClass='theme-icon-adaptive';}else if(stylesheet.includes('adaptive-smooth.css')){iconClass='theme-icon-smooth';}else if(stylesheet.includes('modern.css')){iconClass='theme-icon-modern';}themeCurrent.innerHTML='<i class="'+iconClass+'"></i>';}document.addEventListener('click',function(event){const themeSelector=$('theme-selector');const dropdown=$('theme-dropdown');if(themeSelector&&dropdown&&!themeSelector.contains(event.target)){dropdown.classList.add('theme-dropdown-hidden');}});function handleConnectionChange(event){if(event.type=="offline"){online=false;$('g').style.textDecoration='line-through';stopSSEConnection();}if(event.type=="online"){online=true;$('g').style.textDecoration='none';startSSEConnection();}}function getSelectedText(){if(typeof window.getSelection!=='undefined'){return window.getSelection().trim();}else if(typeof document.selection!=='undefined'){return document.selection.createRange().text.trim();}else{return undefined;}}function search(t){if(t){search_value=t;$('bs').style.background="white url(i/loading.gif)no-repeat 4px center";var xhr=getHTTPObject('search');xhr.open("POST",'https:xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');xhr.send('xhr=1&s='+t);requestTimer=setTimeout((function(){if(xhr){xhr.abort();}}),4000);xhr=undefined;$('s').blur();}t=undefined;return false;}function scroll(){let unreadArticles=Array.from(document.getElementsByClassName("item1"));let rootHeight=DM.offsetHeight-5;const isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);if("IntersectionObserver" in window&&!isSafari){window.addEventListener("resize",scroll);window.addEventListener("orientationChange",scroll);if(imageObserver)imageObserver.disconnect();if($('addblank'))$('addblank').style.height=(DM.offsetHeight-60)+'px';imageObserver=new IntersectionObserver(function(entries,observer){entries.forEach(function(entry){if(entry.isIntersecting||(entry.boundingClientRect.top<0&&entry.rootBounds)){let art=entry.target;if(art.dataset.newArticle==='true'){return;}if(d[art.id]&&d[art.id].r!==0){imageObserver.unobserve(art);read(art.id);cptReadArticle++;}}});},{root:DM,rootMargin:"0px 0px-"+rootHeight+"px 0px",threshold:[0,0.01,1]});unreadArticles.forEach(function(art){imageObserver.observe(art);});let scrollTimeout;let lastScrollTop=DM.scrollTop;let bounceTimeout;let lastBounceTime=0;DM.addEventListener('scroll',function(){clearTimeout(scrollTimeout);scrollTimeout=setTimeout(function(){const currentScrollTop=DM.scrollTop;if(currentScrollTop>lastScrollTop){let unread=Array.from(document.getElementsByClassName("item1"));var fallbackMarked=0;unread.forEach(function(art){if(art.offsetTop<currentScrollTop&&d[art.id]&&d[art.id].r!==0){imageObserver.unobserve(art);read(art.id);cptReadArticle++;fallbackMarked++;}});if(fallbackMarked>0){console.log('FALLBACK:Marked',fallbackMarked,'missed articles as read');}}lastScrollTop=currentScrollTop;clearTimeout(bounceTimeout);bounceTimeout=setTimeout(function(){const now=Date.now();if(now-lastBounceTime<2000)return;const scrollBottom=DM.scrollTop+DM.clientHeight;const scrollHeight=DM.scrollHeight;const addBlank=$('addblank');if(scrollBottom>=scrollHeight-50&&addBlank){const articles=Array.from(document.querySelectorAll('.item1,.item0'));if(articles.length>0){const lastArticle=articles[articles.length-1];const lastArticleTop=lastArticle.offsetTop;const lastArticleHeight=lastArticle.offsetHeight;const lastArticleBottom=lastArticleTop+lastArticleHeight;const visibleTop=Math.max(lastArticleTop,DM.scrollTop);const visibleBottom=Math.min(lastArticleBottom,scrollBottom);const visibleHeight=visibleBottom-visibleTop;const visiblePercentage=(visibleHeight/lastArticleHeight)*100;if(visiblePercentage>0&&visiblePercentage<40){lastBounceTime=now;const targetScroll=lastArticleTop-10;DM.style.scrollBehavior='smooth';DM.scrollTop=targetScroll;setTimeout(()=>{DM.style.scrollBehavior='';},500);}}}},150);},100);},{passive:true});}else{DM.onscroll=oldScroll;DM.onmousewheel=oldScroll;}}function oldScroll(){let count=0;for(let i in d){if(!$(i))continue;count++;if($(i).offsetTop<=DM.scrollTop){if(d[i].r!=0)read(i);}else return;}}function goUp(){DM.scrollTop-=20;}function goDown(){DM.scrollTop+=20;}function goPrev(){if(kona==1||!d)return;var previous=undefined;for(var i in d){if(!$(i))continue;if($(i).offsetTop>DM.scrollTop-10){if(previous){DM.scrollTop=$(previous).offsetTop-10;}return;}previous=i;}if(previous){DM.scrollTop=$(previous).offsetTop-10;}}function goNext(){if(kona==1||!d)return;for(let i in d){if(!$(i))continue;if($(i).offsetTop>DM.scrollTop+10){DM.scrollTop=$(i).offsetTop-10;return;}}if($('addblank'))DM.scrollTop=$('addblank').offsetTop-20;return;}function goPrevPage(){DM.scrollTop-=DM.offsetHeight;}function goNextPage(){DM.scrollTop+=DM.offsetHeight;}function delError(){$('error').style.display="none";}function likedArticle(i){var xhr=getHTTPObject('likedArticle');xhr.open('POST','likedArticle.php',true);xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');xhr.send('xhr=1&f='+i);requestTimer=setTimeout((function(){if(xhr)xhr.abort();}),4000);xhr=undefined;}function markallread(i){var r=confirm("Tout marquer comme lu pour \""+m[i].t+"\" ?");if(r){var xhr=getHTTPObject('markallread');xhr.open("POST",'markallread.php',true);xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');xhr.send('xhr=1&f='+i);requestTimer=setTimeout((function(){if(xhr)xhr.abort();}),4000);xhr=undefined;}r=undefined;return false;}function menu(){myFetch('menu.php').then(result=>{var menu='\t<li id="fsearch" class="flux" title="Recherche" onclick="return false;">Résultats de la recherche</li>\n';m=result;for(var i in m){if(m[i].n>0){menu+='\t<li id="f'+i+'" class="fluxnew" title="'+m[i].d+'" onclick="view('+i+');">'+m[i].t+'<span class="nb_flux">'+m[i].n+'</span><span class="icon"><a title="Tout marquer comme lu" onclick="markallread('+i+')"></a><a title="Se désabonner" onclick="unsubscribe(\''+m[i].t.replace(/'/g,"\\\'")+'\','+i+')"></a></span></li>\n';nb_title+=m[i].n||0;}}$('menu').insertAdjacentHTML('beforeend',menu);D.title='Gheop Reader'+((nb_title>0)? '('+nb_title+')':'');favicon(nb_title);totalItems=nb_title;readItems=0;progressBar();return;})}customElements.define('article-content',class extends HTMLElement{connectedCallback(){const shadow=this.attachShadow({mode:'open'});shadow.innerHTML=this.innerHTML;updateStyle(this);}});function updateStyle(elem){const shadow=elem.shadowRoot;const style=document.createElement("style");shadow.appendChild(style);shadow.querySelector("style").textContent=` .article-content{text-align:justify;padding:10px 10px 0 10px!important;}.article-content>:last-child{margin-bottom:0!important;}.article-content img,.article-content video,.article-content picture,.article-content source{max-width:100%!important;height:auto!important;}.article-content iframe{width:100%!important;max-width:100%!important;height:auto!important;aspect-ratio:16/9!important;border:none;}.article-content pre{max-width:100%;overflow-x:auto;}.spinner{margin:20px auto;width:20px;height:20px;border:4px solid #111;border-top-color:#ff8b8b;border-radius:50%;animation:spin 0.8s linear infinite;}@keyframes spin{to{transform:rotate(360deg);}}`;}function view(i){console.log('===VIEW FEED',i,'===');console.log('Menu counter for feed:',m&&m[i]? m[i].n:'N/A');var oldFeed=$('f'+id);if(oldFeed){oldFeed.classList.remove('show');}id=i;var newFeed=$('f'+id);if(newFeed){newFeed.classList.add('show');}if($('fsearch'))$('fsearch').className="flux";search_active=0;var hasArticlesForFeed=false;var unreadCount=0;var readCount=0;if(d){for(var articleId in d){if(i==='all'||d[articleId].f==i){if(d[articleId].r===1){hasArticlesForFeed=true;unreadCount++;}else if(d[articleId].r===0){readCount++;}}}}console.log('Articles in memory for feed',i,'-Unread:',unreadCount,'Read:',readCount);if(!hasArticlesForFeed&&m&&m[i]&&m[i].n>0){console.log('Feed',i,'has',m[i].n,'articles in menu but none in d,loading feed-specific data');loadData(i,false);return;}if(d&&Object.keys(d).length>0){renderArticles(d,i);if(i!=='all'&&m&&m[i]&&m[i].n>unreadCount){console.log('Feed',i,'has more articles in menu(',m[i].n,')than in memory(',unreadCount,'),triggering preload after 1 second...');setTimeout(()=>preloadFeedArticles(i),1000);}}else{const cached=loadFromCache();if(cached&&cached.articles){renderArticles(cached.articles,i);if(i!=='all'&&m&&m[i]&&m[i].n>0){console.log('Feed',i,'loaded from cache,triggering preload after 1 second...');setTimeout(()=>preloadFeedArticles(i),1000);}}}}function removelight(i){$(i).classList.remove('blink');}function light(i){$(i).classList.add('blink');setTimeout('removelight("'+i+'");',250);}function addflux(){var val=window.prompt("Ajouter le flux:","http(s):affError("Récupération du flux '"+val+"' en cours ...",10);var xhr=getHTTPObject('addflux');xhr.open("POST",'https:xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');xhr.send('xhr=1&link='+encodeURIComponent(val));requestTimer=setTimeout((function(){if(xhr)xhr.abort();}),10000);val=xhr=undefined;}function up(){var xhr=getHTTPObject('up');$('up').style.display="inline-block";$('up').style.animation='spin 4s infinite linear';$('up').style.color="red";xhr.open("POST",'up_parallel.php',true);xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');xhr.send('xhr=1');requestTimer=setTimeout((function(){if(xhr)xhr.abort();}),10000);xhr=undefined;return false;}function unsubscribe(t,f){var r=confirm("Se désinscrire de \""+t+"\" ?");if(r){myFetch('unsubscribe_flux.php','link='+f,1);for(var i in d){if(d[i].f==f){d[i].r=0;if($(i))$(i).style.display='none';}}if($('f'+f).className=='fluxnew show')view('all');$('f'+f).className="flux";}return false;}function editFluxName(idFlux){$('f'+idFlux).innerHTML="<input id=\"focus"+idFlux+"\" type=\"text\" value=\""+m[idFlux].t+"\"/>";$('focus'+idFlux).focus();}function dateArticle(articleDate){if(rtf==undefined){return articleDate;}else{var mydate=new Date(articleDate);var diffDates=mydate-Now;var diffDays=Math.round(diffDates/86400000);var diffHours=Math.round(diffDates/3600000);var diffMinutes=Math.round(diffDates/60000);if(diffMinutes>-46){return rtf.format(diffMinutes,'minute');}else if(diffHours>-24){return rtf.format(diffHours,'hour');}else if(diffDays>-32){return rtf.format(diffDays,'day');}else{return articleDate;}}}function summarize(k){console.log('get summarize for article '+k);$('sum'+k).style.display='none';$('ac'+k).shadowRoot.innerHTML+='<hr/><div id="loader'+k+'" style="display:block;"><div class="spinner"></div></div>';updateStyle($('ac'+k));let formData=new FormData();formData.append('article',$('ac'+k).shadowRoot.children[0].innerText);fetch('https:method:'POST',body:formData}).then(response=>{return response.text();}).then(html=>{const parser=new DOMParser();const doc=parser.parseFromString(html,"text/html");const shadow=$('ac'+k).shadowRoot;shadow.querySelector('#loader'+k).innerHTML=doc.querySelector('html').innerHTML;$('sum'+k).style.display='none';}).catch(error=>{console.error('Failed to fetch page:',error);});}function readability(k){console.log('fetch https:fetch('https:.then(response=>{return response.text()}).then(html=>{const parser=new DOMParser()const doc=parser.parseFromString(html,"text/html")$('ac'+k).shadowRoot.children[0].innerHTML+=doc.querySelector('html').innerHTML;countWords($('ac'+k));$('full'+k).style.display='none';}).catch(error=>{console.error('Failed to fetch page:',error)})}function tagIt(k){let formData=new FormData();formData.append('article',$('ac'+k).shadowRoot.children[0].innerText);console.log('fetch https:fetch('https:.then(response=>{return response.text()}).then(html=>{const parser=new DOMParser()const doc=parser.parseFromString(html,"text/html")$('tag'+k).innerHTML=doc.querySelector('html').innerHTML;}).catch(error=>{console.error('Failed to fetch page:',error)})}function countWords(elem){const text=elem.shadowRoot.innerText||elem.shadowRoot.textContent;const cleanedText=text.trim();if(cleanedText==='')return 0;const words=cleanedText.split(/\s+/);const nbWords=words.length;if(nbWords<100){$('sum'+elem.id.substring(2)).style.display='none';}else{$('sum'+elem.id.substring(2)).style.display='inline';}return;}function generateArticle(i){let datepub=dateArticle(d[i].p);return '<article id="'+i+'" class="item1" onclick="read(this.id,1)">\n\t<header>\n\t\t<h1 class="headline"><a href="'+d[i].l+'" class="title" target="_blank" title="'+d[i].t+'">'+d[i].t+'</a></h1>\n\t\t<div class="byline vcard">\n\t\t\t<address class="author">From<a href="'+d[i].o+'" title="'+d[i].n+'" class="website">'+d[i].n+'</a>'+((d[i].a)?('<a rel="author" class="nickname">'+d[i].a+'</a>'):'')+'</address>\n\t\t\t<time pubdate datetime="'+d[i].p+'" title="'+datepub+'">'+datepub+'</time>\n\t\t</div>\n\t</header>\n\t<article-content id="ac'+i+'"><div class="article-content">'+d[i].d+'</div></article-content>\n\t<div class="action"><a class="lu" onclick="verif('+i+',1);return true;" title="Lu"></a><a id="full'+i+'" class="readability" onclick="readability('+i+')"></a><a id="sum'+i+'" class="summarize" onclick="summarize('+i+')"></a><a class="sendTo" onclick="sendTo('+i+')"></a><a class="print" onclick="printIt('+i+')"></a><span id="tag'+i+'" class="tags icon"><a onclick="tagIt('+i+')"></a></span></div>\n</article>';}function sendToKindle(k){const article=$('ac'+k).shadowRoot.children[0].innerHTML;if(!article){alert("Article introuvable");return;}const data=new FormData();data.append('html',article.outerHTML);data.append('title',d[k].t||"Article RSS");fetch('/send-to-kindle.php',{method:'POST',body:data}).then(response=>response.text()).then(result=>{alert("Article envoyé sur le Kindle!");console.log(result);}).catch(error=>{alert("Erreur lors de l'envoi");console.error(error);});}function printIt(k){let formData=$('ac'+k).shadowRoot.children[0].innerHTML;if(!formData)return;let titleData=d[k].t;const iframe=document.createElement('iframe');iframe.style.position='absolute';iframe.style.left='-9999px';document.body.appendChild(iframe);const doc=iframe.contentWindow.document;doc.open();doc.write(`<html><head><title>${titleData}</title><style>body{font-family:sans-serif;padding:2em;}article{max-width:800px;margin:auto;}</style></head><body>${formData}</body></html>`);doc.close();iframe.onload=()=>{iframe.contentWindow.focus();iframe.contentWindow.print();setTimeout(()=>document.body.removeChild(iframe),1000);};}async function myFetch(url,data,noreturn){try{const response=await fetch(url,{method:"POST",body:data,headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(!noreturn){const json=await response.json();return json;}else{await response.text();return;}}catch(err){console.log('fetch failed',err);}}function getHTTPObject(action){let xhr=new XMLHttpRequest();xhr.onreadystatechange=function(){if(xhr.readyState===4&&xhr.status&&xhr.status===200){var page='';if(action==='addflux'){return xhr.responseText ? affError(xhr.responseText):location.reload();}else if(action==='unsubscribeflux'){return xhr.responseText ? affError(xhr.responseText):location.reload();}else if(action==='up'){location.reload();}else if(action==='more'){if(!xhr.responseText||xhr.responseText=='{}')return 0;var p=JSON.parse(xhr.responseText);if(!p.i||p.i.length===0)return 0;DM.removeChild($('addblank'));cptReadArticle=0;Now=new Date();for(let i in p){loadmore++;d[i]=p[i];page+=generateArticle(i);}page+='<div id="addblank">&nbsp;</div>';DM.insertAdjacentHTML('beforeend',page);$('addblank').style.height=(DM.offsetHeight-60)+'px';loadinprogress=0;p=undefined;}else if(action==='markallread'){location.reload();}else if(action==='search'){search_active=1;$('bs').style.background="white url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAAOxAAADsQBlSsOGwAAAAd0SU1FB9kCBxQkAPQ1ZpQAAAGrSURBVDjLjdRNiE5xFAbw372v14zvkEGsjLD20UghKTay1uykyEIWSpY2Stmp2dhMoWQ1USYbScrKhpKyGkVDNDaGfM21ed5ct/cOp/7dc+89/+c8z/k/9xYoUPkTu7EXm7EQM3iO+3jfp/6v6NTyJbiEY1iE13iXfB+O4BdeoAxo0Q+0yLqGCRxFt1GzChfDctR/xDncxY5ak7KW9+I8JjE8H9iagJ36R9Nek5u43FZUYicGcCv3ZQtYhTk8xFYsbgPcgGnM1jb1A+vFMwxifRtgmdOba1FR1WrhR8MhRRPwA9ZFdtlgVo9ewy34mn0a9inK+KrC4TA9EZvUZe7BweQHAvipoaKABXiVNYoHmeV1PMZbbMcmnIlHh/JuPHabCc7PurS1MfU4VmN5vozjYSdgE7iBFdlzG/u1zGlbvoaleIKnkTaEQ9iIjznhQVyNoiuYwli/wXdwEiOxU5W5vsQdPMLpzLMbT47F7NO4UPRhW9V+FgP4jO+NxiM4G6azebYMk50W+WWG/C12KRpefBO2u7AyDbuY6sxj5uYqatcCX3AvhzgcX479BrxnZh85IOwcAAAAAElFTkSuQmCC)no-repeat 4px center";$('fsearch').className="fluxnew";$('fsearch').innerHTML='Résultats de la recherche "'+search_value+'"';$('f'+id).classList.remove('show');id='search';$('f'+id).classList.add('show');loadmore=0;if(xhr.responseText){d=JSON.parse(xhr.responseText);for(let y=0,tlen=d.i.length;y<tlen;y++){loadmore++;page+='<div id="'+d.i[y].i+'" class="item1">\n\t<a class="date" title="date">'+d.i[y].p+'</a>\n\t<a id="a'+d.i[y].i+'" href="'+d.i[y].l+'" class="title icon" target="_blank" title="'+d.i[y].t+'"> '+d.i[y].t+'</a>\n\t<div class="author">From<a href="}}else{DM.innerHTML='<div id="0" class="item1">\n\t<a class="date" title="date">Maintenant</a>\n\t<a id="a0" href="#" class="title icon" target="_blank" title="Pas de résultat."> Recherche "'+search_value+'"</a>\n\t<div class="author">From<a href=" return false;}page+='<div id="addblank">&nbsp;</div>';DM.innerHTML=page;$('addblank').style.height=(DM.offsetHeight-60)+'px';DM.addEventListener('DOMMouseScroll',scroll,false);DM.onscroll=scroll;DM.onmousewheel=scroll;DM.scrollTop=0;}if(requestTimer)clearTimeout(requestTimer);page=undefined;}else if(xhr.readyState===4)affError('Le serveur n\'a pas répondu assez rapidement. Veuillez réessayer ultérieurement.');return 0;};return xhr;}function verif(k,v=0){if(!d||!d[k]){console.warn('Article '+k+' not found in data object,skipping');return;}if(v==1)(d[k].readblock==0)? d[k].readblock=1:d[k].readblock=0;return(d[k].r==0)? unread(k):read(k);}function unread(k,v=0){if(!d||!d[k]){console.warn('Article '+k+' not found in data object,skipping unread');return;}unr=1;if(v===0)d[k].readblock=1;if(v===1)d[k].readblock=0;if(d[k].r==1||$(k).className=='item1')return;d[k].r=1;$(k).className='item1';locallyModifiedArticles[k]={state:'unread',timestamp:Date.now()};if(nb_title<0)nb_title=0;D.title='Gheop Reader'+((++nb_title>0)? '('+nb_title+')':'');myFetch('unread.php','id='+k,1);if(!m[d[k].f]){console.log('Feed',d[k].f,'not in menu,triggering delayed update');setTimeout(()=>{console.log('Fetching updated data after unread action on missing feed');fetchAndUpdateDataBackground();},300);favicon(nb_title);readItems--;progressBar();return;}m[d[k].f].n++;$('f'+d[k].f).children[0].innerHTML=m[d[k].f].n;$('f'+d[k].f).className="fluxnew";if(id==d[k].f)$('f'+d[k].f).className="fluxnew show";light('f'+d[k].f);favicon(nb_title);readItems--;progressBar();}function read(k,v=0){if(!d||!d[k]){console.warn('Article '+k+' not found in data object,skipping read');return;}if(search_active==1)return;if(d[k].readblock==1)return;if(d[k].r===0)return;if(unr===1){unr=0;return;}d[k].r=0;$(k).className='item0';console.log('READ article',k,'feed:',d[k].f,'-Menu counter before:',m[d[k].f]? m[d[k].f].n:'N/A');queueReadRequest(k);D.title='Gheop Reader'+((--nb_title>0)? '('+nb_title+')':'');if(nb_title<0)nb_title=0;favicon(nb_title);xhr=undefined;readItems++;progressBar();if(!m[d[k].f]){console.log('Feed',d[k].f,'not in menu when marking as read,skipping menu update');return;}m[d[k].f].n--;m[d[k].f].locallyModified=true;console.log('Menu counter after:',m[d[k].f].n,'-Total in title:',nb_title);if(m[d[k].f].n>0){$('f'+d[k].f).children[0].innerHTML=m[d[k].f].n;light('f'+d[k].f);}else{$('f'+d[k].f).children[0].innerHTML='';if(id==d[k].f)$('f'+d[k].f).className="flux show";else $('f'+d[k].f).className="flux";}}function progressBar(){const footer=document.getElementsByTagName("footer")[0];if(!footer)return;if(!totalItems||totalItems===0){footer.setAttribute('style','background:rgba(0,0,0,0.1)!important;position:fixed!important;bottom:0!important;left:0!important;right:0!important;height:4px!important;z-index:1001!important;display:block!important;visibility:visible!important;opacity:1!important;');return;}let perc=((readItems||0)/totalItems)*100;if(perc>100)perc=100;if(perc<0)perc=0;const gradient='linear-gradient(to right,#aaa 0%,#aaa '+perc+'%,rgba(0,0,0,0.1)'+perc+'%,rgba(0,0,0,0.1)100%)';footer.setAttribute('style','background:'+gradient+'!important;position:fixed!important;bottom:0!important;left:0!important;right:0!important;height:4px!important;z-index:1001!important;display:block!important;visibility:visible!important;opacity:1!important;');}var pressedKeys=[],konamiCode=[38,38,40,40,37,39,37,39,66,65];var konamiGameLoop;function konami(){DM.innerHTML='<div id="konami" class="item1"><div class="date">Now!</div><a id="game" class="title">Easter Egg-Dragon Fly-Hold any key to fly-Press ESC to exit</a><div class="author">From<a href="https:$('konami').style.display='block';DM.scrollTop=0;kona=1;var a=$('c');var c=a.getContext('2d');a.style.width=(a.width=1e3)+"px";a.style.height=(a.height=500)+"px";for(p in c){c[p[0]+(p[6]||"")]=c[p];}var J,K,C,B,u,D,E,F,G,H,I,L,M,N,O,t,U,K2,Q,R,i;J=K=C=B=0;u=50;D=250;E=F=G=H=1;I=250;konamiGameLoop=setInterval(function(){L=300;M=500;N=400;with(c){A=function(S,x,y,T){T&&a(x,y,T,0,7,0);fillStyle=S.P ? S:"#"+"ceff99aaffff333f99ff7".substr(S*3,3);fill();ba();};A(0,0,0,10000);A(6,800,300,140);O=G*u%400;l(0-O,N+100);l(0-O,N);for(i=0;i<7;i++){qt(i*200+100-O,i%2 ? L:M,i*200+200-O,N);}l(i*200-O,N+100);ca();fillStyle="#5c1";fill();ba();t=(G*(u+E)+I)%200/200;U=1-t;K2=U*U*N+2*t*U*((G*(u+E)+I)%400>200 ? L:M)+t*t*N;D+=F;if(D>=K){if(K2<K){if(F>0&&(K2-K)<0&&!J){E=E/3;K2=K;}E-=E<2 ? 0:0.1;}else{E+=0.1*H*H;}J=1;D=K;if(K2<K&&F>(K2-K)){F=(K2-K);}}else{J=0;}F+=0.4*H;K=K2;A(3-H,I,D-10,10);A(3,I+3,D-12,4);A(4,I+4,D-12,1);Q=200+Math.pow(B,1.3)-u;R=50+Math.sin(B/2)*2;A(1,Q,R,30);A(3,Q+20,R+5,7);A(4,Q+22,R+7,2);A(6,0,0,0);fx(++B+" ☆",5,10);fx((C<B ? C=B:C)+" ★",40,10);if(Q>4*I){clearInterval(konamiGameLoop);setTimeout(function(){if(confirm("Game Over!Score:"+B+"\nBest:"+C+"\n\nPlay again?")){E=F=u=B=K=2;konamiGameLoop=setInterval(arguments.callee,30);}},100);}}u+=E;},30);window.konamiKeyHandler=function(evt){var b=evt;H=b.type[5]? 2:1;};}function konamistop(){kona=0;if(konamiGameLoop)clearInterval(konamiGameLoop);if($('konami'))$('konami').style.display='none';window.konamiKeyHandler=null;}function i(){favicon_badge=new Favico({animation:'none'});if($('fall')){$('fall').classList.add('show');}loadData('all');startSSEConnection();window.addEventListener('online',handleConnectionChange);window.addEventListener('offline',handleConnectionChange);window.addEventListener('beforeunload',stopSSEConnection);window.onresize=scroll;$('s').onfocus=function(){search_focus=1;};$('s').onblur=function(){search_focus=0;};D.onkeydown=function(evt){if(search_focus===1)return;var k=(evt.which)? evt.which:evt.keyCode;if(kona==1){if(k==27){konamistop();return;}if(window.konamiKeyHandler){window.konamiKeyHandler(evt);}return;}if(pressedKeys.length==konamiCode.length)pressedKeys.shift();pressedKeys.push(k);if(pressedKeys.toString()==konamiCode.toString())konami();switch(k){case 33:goPrevPage();break;case 34:goNextPage();break;case 78:goNext();break;case 39:goNext();break;case 80:goPrev();break;case 37:goPrev();break;case 38:goUp();break;case 40:goDown();break;case 71:goGoogle();break;case 87:goWikipedia();break;case 79:openActif();break;default:break;}k=undefined;};const resizer=document.getElementById('menu-resizer');const nav=document.querySelector('nav');const main=document.querySelector('main');let isResizing=false;resizer.addEventListener('mousedown',(e)=>{isResizing=true;document.body.classList.add('resizing');const onMouseMove=(e)=>{if(!isResizing)return;let newWidth=e.clientX;if(newWidth<20){newWidth=0;resizer.innerHTML='⇹';resizer.style.height='auto';}else{resizer.innerHTML='';resizer.style.height='100%';}if(newWidth>window.innerWidth*0.6)newWidth=window.innerWidth*0.6;nav.style.width=newWidth+'px';resizer.style.left=newWidth+'px';main.style.left=newWidth+'px';localStorage.setItem('menuWidth',newWidth);};const onMouseUp=()=>{isResizing=false;document.body.classList.remove('resizing');document.removeEventListener('mousemove',onMouseMove);document.removeEventListener('mouseup',onMouseUp);};document.addEventListener('mousemove',onMouseMove);document.addEventListener('mouseup',onMouseUp);});window.addEventListener('DOMContentLoaded',()=>{const savedWidth=localStorage.getItem('menuWidth');if(savedWidth){nav.style.width=(parseInt(savedWidth))+'px';resizer.style.left=(parseInt(savedWidth))+'px';if(savedWidth<20){resizer.innerHTML='⇹';resizer.style.height='auto';}main.style.left=(parseInt(savedWidth))+'px';}});}function openActif(){if(kona==1)return;if(!d)return;for(var k=0,len=d.i.length;k<=len;k++){if(!(d.i[k])){return;}else if($(d.i[k].i).offsetTop>=DM.scrollTop){window.focus();window.open(d.i[k].l).blur();window.self.focus();goNext();return;}}k=len=undefined;log("Fenêtre active non trouvée!");}function goWikipedia(){var t=getSelectedText();if(t&&t!=='')window.open(" return false;}function goGoogle(){var t=getSelectedText();if(t&&t!=='')window.open("https:return false;}function more(){var xhr=getHTTPObject('more');xhr.open('POST','view.php',true);xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');if(id&&id!=='all')xhr.send('xhr=1&nb=10&id='+id);else xhr.send('xhr=1&nb=10');requestTimer=setTimeout((function(){if(xhr)xhr.abort();}),4000);xhr=undefined;}function log(t){if(typeof console!=='undefined'){if(typeof t=='object')console.table(t);else console.log(t);}}function affError(text,n){n=typeof n!=='undefined' ? n:4;if('Notification' in window){Notification.requestPermission(function(permission){if(permission==='granted'){var notification=new Notification('Gheop Reader',{body:text,});setTimeout(function(){notification.close()},n*1000);}else notif=true;});}else{notif=true;}if(notif){$('error').innerHTML=text;$('error').style.display='block';setTimeout(delError,n*1000);}}document.onload=i();window.addEventListener('DOMContentLoaded',()=>{const savedTheme=localStorage.getItem('theme');if(savedTheme==='dark'){$('stylesheet').href='themes/dark.css';}else if(savedTheme==='light'){$('stylesheet').href='themes/light.css';}else if(savedTheme==='adaptive'){$('stylesheet').href='themes/adaptive.css';setTimeout(()=>{if(window.startAdaptiveTheme){startAdaptiveTheme();}},100);}else if(savedTheme==='smooth'){$('stylesheet').href='themes/adaptive-smooth.css';setTimeout(()=>{if(window.startSmoothAdaptiveTheme){startSmoothAdaptiveTheme();}},100);}else if(savedTheme==='modern'){$('stylesheet').href='themes/modern.css';}else{if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:dark)').matches){$('stylesheet').href='themes/dark.css';}}setTimeout(()=>{if(window.updateThemeIcon){updateThemeIcon();}},100);});const lightTheme={bgBody:'#ffffff',bgMain:'#eeeeee',bgItem:'#ffffff',bgShow:'#e8e8e8',bgInput:'#ffffff',textBody:'#1a1a1a',textLink:'#2a2a2a',textLight:'#666666',textWhite:'#333333',shadowItem:'rgba(0,0,0,0.15)',border:'#dddddd'};const darkTheme={bgBody:'#1a1a1a',bgMain:'#2b2b2b',bgItem:'#3a3a3a',bgShow:'#2b2b2b',bgInput:'#333333',textBody:'#e0e0e0',textLink:'#b8b8b8',textLight:'#999999',textWhite:'#f5f5f5',shadowItem:'rgba(0,0,0,0.5)',border:'#4a4a4a'};function interpolateColor(color1,color2,factor){if(color1.startsWith('rgba')){const rgba1=color1.match(/[\d.]+/g).map(Number);const rgba2=color2.match(/[\d.]+/g).map(Number);const r=Math.round(rgba1[0]+(rgba2[0]-rgba1[0])*factor);const g=Math.round(rgba1[1]+(rgba2[1]-rgba1[1])*factor);const b=Math.round(rgba1[2]+(rgba2[2]-rgba1[2])*factor);const a=rgba1[3]+(rgba2[3]-rgba1[3])*factor;return `rgba(${r},${g},${b},${a})`;}const hex1=color1.replace('#','');const hex2=color2.replace('#','');const r1=parseInt(hex1.substr(0,2),16);const g1=parseInt(hex1.substr(2,2),16);const b1=parseInt(hex1.substr(4,2),16);const r2=parseInt(hex2.substr(0,2),16);const g2=parseInt(hex2.substr(2,2),16);const b2=parseInt(hex2.substr(4,2),16);const r=Math.round(r1+(r2-r1)*factor);const g=Math.round(g1+(g2-g1)*factor);const b=Math.round(b1+(b2-b1)*factor);return `rgb(${r},${g},${b})`;}function calculateThemeIntensity(){const now=new Date();const hours=now.getHours();const minutes=now.getMinutes();const totalMinutes=hours*60+minutes;const morningStart=6*60;const morningEnd=10*60;const eveningStart=16*60;const eveningEnd=20*60;let intensity;if(totalMinutes>=morningStart&&totalMinutes<morningEnd){const progress=(totalMinutes-morningStart)/(morningEnd-morningStart);intensity=1-progress;}else if(totalMinutes>=morningEnd&&totalMinutes<eveningStart){intensity=0;}else if(totalMinutes>=eveningStart&&totalMinutes<eveningEnd){const progress=(totalMinutes-eveningStart)/(eveningEnd-eveningStart);intensity=progress;}else{intensity=1;}return intensity;}function applyAdaptiveTheme(){const rawIntensity=calculateThemeIntensity();const root=document.documentElement;let intensity=rawIntensity<=0.5 ? 0:1;root.style.setProperty('--adaptive-bg-body',interpolateColor(lightTheme.bgBody,darkTheme.bgBody,intensity));root.style.setProperty('--adaptive-bg-main',interpolateColor(lightTheme.bgMain,darkTheme.bgMain,intensity));root.style.setProperty('--adaptive-bg-item',interpolateColor(lightTheme.bgItem,darkTheme.bgItem,intensity));root.style.setProperty('--adaptive-bg-show',interpolateColor(lightTheme.bgShow,darkTheme.bgShow,intensity));root.style.setProperty('--adaptive-bg-input',interpolateColor(lightTheme.bgInput,darkTheme.bgInput,intensity));root.style.setProperty('--adaptive-text-body',interpolateColor(lightTheme.textBody,darkTheme.textBody,intensity));root.style.setProperty('--adaptive-text-link',interpolateColor(lightTheme.textLink,darkTheme.textLink,intensity));root.style.setProperty('--adaptive-text-light',interpolateColor(lightTheme.textLight,darkTheme.textLight,intensity));root.style.setProperty('--adaptive-text-white',interpolateColor(lightTheme.textWhite,darkTheme.textWhite,intensity));root.style.setProperty('--adaptive-shadow-item',interpolateColor(lightTheme.shadowItem,darkTheme.shadowItem,intensity));root.style.setProperty('--adaptive-border',interpolateColor(lightTheme.border,darkTheme.border,intensity));root.style.setProperty('--theme-intensity',intensity);const now=new Date();console.log(`Adaptive theme:${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}-raw:${rawIntensity.toFixed(2)},adjusted:${intensity.toFixed(2)}`);}function startAdaptiveTheme(){applyAdaptiveTheme();setInterval(applyAdaptiveTheme,5*60*1000);}window.startAdaptiveTheme=startAdaptiveTheme;window.applyAdaptiveTheme=applyAdaptiveTheme;const smoothLightTheme={bgBody:'#faf7ef',bgMain:'#faf7ef',bgItem:'#ffffff',bgShow:'#eae4d5',bgInput:'#ffffff',textBody:'#1a0f08',textLink:'#7a3e0a',textLight:'#5c4a3a',shadowItem:'rgba(101,67,33,0.15)',border:'#d4caba',accent:'#c65d1f'};const smoothDarkTheme={bgBody:'#0f0b08',bgMain:'#1f1812',bgItem:'#2f2519',bgShow:'#1f1812',bgInput:'#292016',textBody:'#fff9ed',textLink:'#ffb366',textLight:'#d4c4ae',shadowItem:'rgba(0,0,0,0.5)',border:'#4a3f2f',accent:'#ff9966'};function applySmoothAdaptiveTheme(){const rawIntensity=calculateThemeIntensity();const root=document.documentElement;const intensity=rawIntensity;root.style.setProperty('--adaptive-bg-body',interpolateColor(smoothLightTheme.bgBody,smoothDarkTheme.bgBody,intensity));root.style.setProperty('--adaptive-bg-main',interpolateColor(smoothLightTheme.bgMain,smoothDarkTheme.bgMain,intensity));root.style.setProperty('--adaptive-bg-item',interpolateColor(smoothLightTheme.bgItem,smoothDarkTheme.bgItem,intensity));root.style.setProperty('--adaptive-bg-show',interpolateColor(smoothLightTheme.bgShow,smoothDarkTheme.bgShow,intensity));root.style.setProperty('--adaptive-bg-input',interpolateColor(smoothLightTheme.bgInput,smoothDarkTheme.bgInput,intensity));root.style.setProperty('--adaptive-text-body',interpolateColor(smoothLightTheme.textBody,smoothDarkTheme.textBody,intensity));root.style.setProperty('--adaptive-text-link',interpolateColor(smoothLightTheme.textLink,smoothDarkTheme.textLink,intensity));root.style.setProperty('--adaptive-text-light',interpolateColor(smoothLightTheme.textLight,smoothDarkTheme.textLight,intensity));root.style.setProperty('--adaptive-shadow-item',interpolateColor(smoothLightTheme.shadowItem,smoothDarkTheme.shadowItem,intensity));root.style.setProperty('--adaptive-border',interpolateColor(smoothLightTheme.border,smoothDarkTheme.border,intensity));root.style.setProperty('--adaptive-accent',interpolateColor(smoothLightTheme.accent,smoothDarkTheme.accent,intensity));root.style.setProperty('--theme-intensity',intensity);const now=new Date();console.log(`Smooth adaptive theme:${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}-intensity:${intensity.toFixed(2)}(progressive)`);}function startSmoothAdaptiveTheme(){applySmoothAdaptiveTheme();setInterval(applySmoothAdaptiveTheme,5*60*1000);}window.startSmoothAdaptiveTheme=startSmoothAdaptiveTheme;window.applySmoothAdaptiveTheme=applySmoothAdaptiveTheme;window.testAdaptiveThemeAt=function(hours,minutes=0){if(typeof hours!=='number'||hours<0||hours>23){console.error('❌ Heure invalide. Utilisez un nombre entre 0 et 23.');console.log('💡 Exemple:testAdaptiveThemeAt(8,30)pour tester à 8h30');return;}if(typeof minutes!=='number'||minutes<0||minutes>59){console.error('❌ Minutes invalides. Utilisez un nombre entre 0 et 59.');return;}if(!$('stylesheet').href.includes('adaptive.css')){console.warn('⚠️ Le thème adaptatif n\'est pas activé. Changez de thème d\'abord!');console.log('💡 Cliquez sur l\'icône de thème pour cycler jusqu\'au mode adaptatif(icône horloge)');return;}const totalMinutes=hours*60+minutes;const morningStart=6*60;const morningEnd=10*60;const eveningStart=16*60;const eveningEnd=20*60;let rawIntensity;let phase;if(totalMinutes>=morningStart&&totalMinutes<morningEnd){const progress=(totalMinutes-morningStart)/(morningEnd-morningStart);rawIntensity=1-progress;phase='🌅 Transition matin(sombre → clair)';}else if(totalMinutes>=morningEnd&&totalMinutes<eveningStart){rawIntensity=0;phase='☀️ Jour(clair)';}else if(totalMinutes>=eveningStart&&totalMinutes<eveningEnd){const progress=(totalMinutes-eveningStart)/(eveningEnd-eveningStart);rawIntensity=progress;phase='🌆 Transition soir(clair → sombre)';}else{rawIntensity=1;phase='🌙 Nuit(sombre)';}let intensity=rawIntensity<=0.5 ? 0:1;console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');console.log(`🕐 Test à ${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`);console.log(`📊 Intensité:${intensity.toFixed(2)}(0=clair,1=sombre)`);console.log(`🎨 Phase:${phase}`);console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');const root=document.documentElement;root.style.setProperty('--adaptive-bg-body',interpolateColor(lightTheme.bgBody,darkTheme.bgBody,intensity));root.style.setProperty('--adaptive-bg-main',interpolateColor(lightTheme.bgMain,darkTheme.bgMain,intensity));root.style.setProperty('--adaptive-bg-item',interpolateColor(lightTheme.bgItem,darkTheme.bgItem,intensity));root.style.setProperty('--adaptive-bg-show',interpolateColor(lightTheme.bgShow,darkTheme.bgShow,intensity));root.style.setProperty('--adaptive-bg-input',interpolateColor(lightTheme.bgInput,darkTheme.bgInput,intensity));root.style.setProperty('--adaptive-text-body',interpolateColor(lightTheme.textBody,darkTheme.textBody,intensity));root.style.setProperty('--adaptive-text-link',interpolateColor(lightTheme.textLink,darkTheme.textLink,intensity));root.style.setProperty('--adaptive-text-light',interpolateColor(lightTheme.textLight,darkTheme.textLight,intensity));root.style.setProperty('--adaptive-text-white',interpolateColor(lightTheme.textWhite,darkTheme.textWhite,intensity));root.style.setProperty('--adaptive-shadow-item',interpolateColor(lightTheme.shadowItem,darkTheme.shadowItem,intensity));root.style.setProperty('--adaptive-border',interpolateColor(lightTheme.border,darkTheme.border,intensity));root.style.setProperty('--theme-intensity',intensity);console.log('✅ Thème appliqué!Regardez les changements dans l\'interface.');console.log('');console.log('💡 Astuce:Testez rapidement plusieurs heures:');console.log(' testAllHours()-Affiche l\'intensité pour toutes les heures');console.log(' testAdaptiveThemeAt(6)-Matin(début transition)');console.log(' testAdaptiveThemeAt(8)-Matin(milieu)');console.log(' testAdaptiveThemeAt(14)-Jour');console.log(' testAdaptiveThemeAt(18)-Soir(milieu transition)');console.log(' testAdaptiveThemeAt(22)-Nuit');};window.testAllHours=function(){console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');console.log('📊 INTENSITÉ DU THÈME ADAPTATIF SUR 24 HEURES');console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');console.log('');const morningStart=6*60;const morningEnd=10*60;const eveningStart=16*60;const eveningEnd=20*60;for(let h=0;h<24;h++){const totalMinutes=h*60;let intensity;let bar='';let phase='';if(totalMinutes>=morningStart&&totalMinutes<morningEnd){const progress=(totalMinutes-morningStart)/(morningEnd-morningStart);intensity=1-progress;phase='🌅';}else if(totalMinutes>=morningEnd&&totalMinutes<eveningStart){intensity=0;phase='☀️ ';}else if(totalMinutes>=eveningStart&&totalMinutes<eveningEnd){const progress=(totalMinutes-eveningStart)/(eveningEnd-eveningStart);intensity=progress;phase='🌆';}else{intensity=1;phase='🌙';}const barLength=Math.round(intensity*20);const lightLength=20-barLength;bar='█'.repeat(barLength)+'░'.repeat(lightLength);console.log(`${phase}${String(h).padStart(2,'0')}h[${bar}]${intensity.toFixed(2)}`);}console.log('');console.log('Légende:0.00=clair maximum,1.00=sombre maximum');console.log('🌙 Nuit|🌅 Transition matin|☀️ Jour|🌆 Transition soir');console.log('');console.log('💡 Pour tester une heure:testAdaptiveThemeAt(14)ou testAdaptiveThemeAt(18,30)');console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');};window.addEventListener('DOMContentLoaded',()=>{setTimeout(()=>{if($('stylesheet')&&$('stylesheet').href.includes('adaptive.css')){console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');console.log('🎨 THÈME ADAPTATIF ACTIF');console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');console.log('');console.log('📝 Commandes disponibles dans la console:');console.log('');console.log(' testAdaptiveThemeAt(14)-Tester le thème à 14h');console.log(' testAdaptiveThemeAt(18,30)-Tester le thème à 18h30');console.log(' testAllHours()-Voir l\'intensité sur 24h');console.log('');console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');}if(window.progressBar){progressBar();}},500);});