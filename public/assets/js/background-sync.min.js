const DB_NAME="gheop-reader",DB_VERSION=1,STORE_NAME="read-queue",SYNC_TAG="sync-read-articles";async function queueReadMark(e){if(navigator.onLine)try{return await markArticleRead(e),console.log("[Sync] Article marked as read immediately:",e),!0}catch(e){console.warn("[Sync] Failed to mark online, queuing:",e)}try{return await addToQueue(e),await registerBackgroundSync(),console.log("[Sync] Article queued for background sync:",e),showSyncNotification("Article mis en file d'attente"),!0}catch(e){return console.error("[Sync] Failed to queue article:",e),!1}}async function markArticleRead(e){const n=new FormData;n.append("id",e);const o=await fetch("/read.php",{method:"POST",body:n});if(!o.ok)throw new Error(`Server returned ${o.status}`);return o}async function addToQueue(e){return new Promise((n,o)=>{const t=indexedDB.open(DB_NAME,1);t.onerror=()=>o(t.error),t.onupgradeneeded=e=>{const n=e.target.result;n.objectStoreNames.contains(STORE_NAME)||n.createObjectStore(STORE_NAME,{keyPath:"id"})},t.onsuccess=()=>{const r=t.result,c=r.transaction(STORE_NAME,"readwrite"),a=c.objectStore(STORE_NAME),s={id:e,timestamp:Date.now()};a.put(s),c.oncomplete=()=>{r.close(),n()},c.onerror=()=>{r.close(),o(c.error)}}})}async function registerBackgroundSync(){if("serviceWorker"in navigator&&"sync"in self.registration)try{const e=await navigator.serviceWorker.ready;await e.sync.register(SYNC_TAG),console.log("[Sync] Background sync registered")}catch(e){console.error("[Sync] Failed to register background sync:",e)}else console.warn("[Sync] Background Sync not supported")}async function getPendingCount(){return new Promise((e,n)=>{const o=indexedDB.open(DB_NAME,1);o.onsuccess=()=>{const t=o.result;if(!t.objectStoreNames.contains(STORE_NAME))return t.close(),void e(0);const r=t.transaction(STORE_NAME,"readonly").objectStore(STORE_NAME).count();r.onsuccess=()=>{t.close(),e(r.result)},r.onerror=()=>{t.close(),n(r.error)}},o.onerror=()=>n(o.error)})}function showSyncNotification(e){const n=document.createElement("div");n.textContent=e,n.style.cssText="\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    background: #2c3e50;\n    color: white;\n    padding: 12px 20px;\n    border-radius: 4px;\n    box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n    z-index: 10000;\n    font-size: 14px;\n    animation: slideIn 0.3s ease-out;\n  ",document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideOut 0.3s ease-in",setTimeout(()=>n.remove(),300)},3e3)}"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{if(e.data&&"SYNC_COMPLETE"===e.data.type){const{synced:n,total:o}=e.data;console.log(`[Sync] Sync complete: ${n}/${o} articles`),n>0&&(showSyncNotification(`${n} article(s) synchronis√©(s)`),"function"==typeof updateCounts&&updateCounts())}}),window.BackgroundSync={queueReadMark:queueReadMark,getPendingCount:getPendingCount,registerBackgroundSync:registerBackgroundSync};